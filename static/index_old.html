<!DOCTYPE html>
<html class="no-js" lang='ca'>
<!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width">

	<style>
		body{font-family: verdana, arial, helvetica}
	</style>

	<script type="text/javascript" src="http://sc-pre.aoc.cat/appletCentralitzat/resources/js/commons/jquery-1.11.3.min.js"></script>
	
	<script type="text/javascript">
	
	
		var serveiUrl = {
				baseUrl : 'http://sc-pre.aoc.cat/appletCentralitzat',
				appUrl : 'http://test-applet-centralitzat.eu-gb.mybluemix.net',
				getStartSignUrl : function(){
					return this.baseUrl + '/startSignProcess';
				},
				getResponseSignature : function(){
					return this.baseUrl + '/responseSignature';
				},
				getReciveSignatureUrl : function(){
					return this.appUrl + '/demo/receiveSignature';
				},
				getCheckReceiveSignature : function(){
					return this.appUrl + "/demo/checkReceiveSignature";
				}
		};
	
		var appletCfg = {
				callbackUrl : serveiUrl.getReciveSignatureUrl(),
				id_intern : "1",
				descripcio : "descripcio de proves",
				applet_cfg : { 	
					keystore_type : "1",
					signature_mode : "12",
					doc_type : "3",
					js_event : "true",
					signButtonCaption : "Signa",
					document_to_sign : "gYbYj9w6DofPvCfwqKKwXitsErA="
			  }
		};
		
		var appletApsaCfg = {
				callbackUrl : serveiUrl.getReciveSignatureUrl(),
				id_intern : "2",
				descripcio : "descripcio de proves apsa",
				applet_apsa_cfg : { 
					keystore_type : "1",
					hash_a_xifrar : "gYbYj9w6DofPvCfwqKKwXitsErA=;gYbYj9w6DofPvCfwqKKwXitsErA=",
					//signingCertificate : "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"
		  	  }
		};
				
		function test(apsa) {
			
			var newWindow = window.open();
			
			var data = '';
			if( !apsa ){
				data = JSON.stringify(appletCfg);
			}else {
				data = JSON.stringify(appletApsaCfg);
			}
			
			$.ajax({
		    	headers: { 
		        	'Accept': 'application/json',
		        	'Content-Type': 'application/json' 
		    	},
		    	'type': 'POST',
		    	'url': serveiUrl.getStartSignUrl(),
		    	'data': data,
		    	'dataType': 'json',
		    	'success': callback(newWindow),
		    	'error' : function(){
		    		//newWindow.close();
		    		alert('error')
		    	}
			});
		}


		var callback = function (window){ 
			return function (data){
				if(data.status === 'OK'){
					window.location = serveiUrl.baseUrl+'?id=' + data.tokenId;
					demoInterval = setInterval( function(){
						checkReceiveSignatura(data.tokenId);
					}, 10000);
				}else{
					alert(data.message);
					window.close();
				}
			}
		};
		
		var callbackReceive = function (data){
			console.log(data)
			if(data.length>0){
				alert("Ja hem rebut el document signat");
				$('body').append('<br /><br />Contingut de la signatura:<br /><textarea cols="100" rows="200">' + data + '</textarea>');
				clearInterval(demoInterval);
			}
		};

		
		function checkReceiveSignatura( token ){
			$.ajax({
		    	headers: { 
		        	'Accept': 'application/json',
		        	'Content-Type': 'application/json' 
		    	},
		    	'type': 'POST',
		    	'url': serveiUrl.getCheckReceiveSignature(),
		    	'data': JSON.stringify({"token" : token }),
		    	'dataType': 'text',
		    	'success': callbackReceive,
		    	'error' : function(err){
		    		alert('error')
		    	}
			});
		}
		
	</script>
</head>
<body>

		<div>
			<p><img src="http://www.gencat.cat/img/logo.gif"></p>
		</div>

		<h1>Test Applet Centralitzat de Signatura de l'AOC</h1>

		<h2>Passes:</h2>

		<ol>
			<li>Clicar el bot&oacute;: s'obrir&agrave; una nova pestanya del navegador amb les dades de la signatura</li>
			<li>En la nova finestra, clicar per a descarregar el fitxer de configuraci&oacute; de la signatura </li>
			<li>Clicar en el fitxer descarregat (&eacute;s un fitxer JNLP que arrencar&agrave; l'aplicaci&oacute; JAVA de signatura), acceptar el "run" de l'aplicaci&oacute; JAVA i introduir el PIN de la tarja amb el certificat</li>
			<li>Despr&eacute;s d'uns segons, el contingut de la signatura es mostrar&agrave; en la part inferior d'aquesta p&agrave;gina</li>
		</ol>

		<div id="button">
 			<input type="button" value="Signatura de prova..." onClick="test(false);"></input>
 			&nbsp;
 			<!--input type="button" value="TEST APSA..." onClick="test(true);"></input--> 		
 		</div>



</body>
</html>
