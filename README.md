<img src="data:image/gif;base64,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" />

# Applet de Signatura Centralitzat de l'AOC

## Requeriments

* jQuery: https://code.jquery.com/

* [applet_centralitzat.js](https://github.com/cs-canigo/applet-centralitzat/blob/master/static/js/applet_centralitzat.js)

* Java instal·lat a la m&agrave;quina que realitza la signatura

* Mentre no estigui publicat el DNS preproductiu de l'Applet Centralitzat, s'ha d'actualitzar el fitxer /etc/hosts de la m&agrave;quina des d'on es provi amb l'entrada: 213.27.191.82 sc-pre.aoc.cat

## Com funciona?

Mitjançant el protocol JNLP (Java Network Launch Protocol) el servei de l'AOC que substitueix l'Applet de Signatura genera un fitxer amb les dades a signar. En clicar en aquest fitxer s'aixeca l'aplicaci&oacute; mitjan&ccedil;ant JWS (Java Web Start) que substitueix l'antic applet que s'incrustava al navegador (ara est&agrave; fora directament sobre el sistema operatiu).

## Com preparar la plana web

L'objecte de javacript *applet* que s'instancia en carregar la plana, exposa un m&egrave;tode "sign" al que se li passar&agrave; la configuraci&oacute; de la signatura (de la mateixa manera que es feia amb l'antic applet).

		
		<!DOCTYPE html>
		<html>
			<head>

				<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.2.min.js"></script>
				<script type="text/javascript" src="/demo/js/applet_centralitzat.js"></script>

				<script>

					...

					
					applet.sign(config);

					...

				</script>

			</head>
			<body>

				....

			</body>
		</html>

## Canvi de l'antic Applet per l'Applet Centralitzat

Un cop fets els canvis anteriors, el canvi és relativament senzill: els paràmetres de configuració de l'antic applet:

		<param name = "keystore_type" value = "1">
		<param name = "signature_mode" value = "12">
		<param name = "doc_type" value = "3">
		<param name = "document_to_sign" value = "wu6nT5Z9b0gu7jBzri+8v6fysVc=">
		<param name = "form_fill" value = "true">
		<param name = "form_fill_form" value = "appletCATcertForm">
		<param name = "form_fill_field" value = "result">
		<param name = "signButtonCaption" value = "Signa">

S'han de convertir en un objecte JSON que es passa al m&eacute;tode "sign" de l'objecte javascript.

		{
			"keystore_type" : "1",
			"signature_mode" : "12",
			"doc_type" : "3",
			"document_to_sign" : "wu6nT5Z9b0gu7jBzri+8v6fysVc=",
			"form_fill" : "true",
			"form_fill_form" : "appletCATcertForm",
			"form_fill_field" : "result",
			"signButtonCaption" : "Signa"
		}

Les propietats signButtonCaption i js_event s'injecten per defecte amb els valors "Signa" i true. 

## Aplicaci&oacute; de demo

L'aplicaci&oacute; de demo est&agrave; formada per dues parts:

- Client: aplicaci&oacute; html i javascript que gestiona la comunicaci&oacute; amb l'Applet Centralitzat
- Servidor: aplicaci&oacute; NodeJS que rep la resposta de l'Applet Centralitzat amb el resultat de la signatura. 
	
	- ha d'implementar el m&egrave;tode http POST
	- rebr&agrave; una resposta al __body__ de la petici&oacute; amb el seg&uuml;ent contingut (JSON):

			{
				"signResult" : "xxxxxxxxxxxxxxxxxxxxxxx",
				"token" : "yyyyyyyyyyyyyyy"
			}

Es pot veure un exemple aqu&iacute;: http://test-applet-centralitzat.eu-gb.mybluemix.net/demo/